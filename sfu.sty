\NeedsTeXFormat{LaTeX2e}[1995/12/01]
\ProvidesPackage{sfu}[2014/09/16 Siberian Federal University standart]

\sloppy % боремся с overfull'ами
\hyphenpenalty=10000 % запрещаем переносы
\relpenalty=10000 % запрещаем переносы в формулах

\RequirePackage{ifxetex}
\ifxetex
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	%%%%% Заводим XeLaTeX %%%%%%%%%%
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	\RequirePackage{polyglossia}
	\setdefaultlanguage{russian}
	\setotherlanguage{english}
	\defaultfontfeatures{Mapping=tex-text}%  Как минимум позволяет использовать `` '' как кавычки.
	\setmainfont{Linux Libertine O}
	\setsansfont{Linux Biolinum O}
	% \setmonofont{Linux Libertine Mono O}
	\setmonofont{Ubuntu Mono}
	% \newfontfamily\cyrillicfonttt[Script=Cyrillic]{Linux Libertine Mono O}
	\newfontfamily\cyrillicfonttt[Script=Cyrillic]{Ubuntu Mono}
\else
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	%%%%% Подключаем кириллицу %%%%%
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	\RequirePackage[T2A]{fontenc}
	\RequirePackage[cp1251]{inputenc}
	\RequirePackage[english, russian]{babel}
	%\RequirePackage{pscyr}% Зло
	%\renewcommand{\rmdefault}{ftm}% Times New Roman % Такое же зло в смысле непредсказуемости вызываемых ошибок
\fi
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% Страница %%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%>> Абзацный отступ должен быть одинаковым по всему тексту документа и равен пяти знакам (12,5 мм).
\setlength\parindent{12.5mm}
\linespread{1.3} % Вместо \onehalfspacing для полуторного интервала
%>> 7.1.2 Текст МД, ДР, БР, КР, контрольных работ, РГЗ, РГР, а также рефератов, эссе, отчетов по всем видам практик, научно-исследовательским и лабораторным работам печатают на листах (без рамки) с соблюдением следующих размеров полей: 
%>> левого – 30 мм;
%>> верхнего и нижнего – 20 мм;
%>> правого – 10 мм.
\RequirePackage[left=3cm,top=2cm,bottom=2cm,right=1cm]{geometry}

%%%%% Таблицы и рисунки %%%%%
\RequirePackage{ccaption}
\captionstyle{\raggedright} % Названия выключены влево
\captiondelim{ --- } % Тире вместо двоеточия
%% Переопределение в рамках пакета babel
\addto\captionsrussian{\renewcommand{\figurename}{Рисунок}}% Рисунок вместо Рис.

%%%%% Настраиваем представление списков
\renewcommand{\@listI}{%
	\leftmargin=\parindent % отступ от левого поля (или объемлющего списка!) до начала текста элементов перечня. Заголовок перечня будет левее на \labelwidth + \labelsep
	\rightmargin=0pt 
	\labelsep=5pt % расстояние между выключенным вправо заголовком перечня и основным текстом
	\labelwidth=20pt % минимальная ширина заголовка по-умолчанию
	\itemindent=0pt  % дополнительное смещение заголовка перечня вправо
	\listparindent=0pt % абзацный отступ во всех, кроме первого, абзацах каждого элемента перечня
	\topsep=8pt plus 2pt minus 4pt % доп (к \parskip) верт отступ до и после перечня
	\partopsep=2pt plus 1pt minus 1pt % доп верт отступ до и после перечня, если перед ним пустая строка (или \par)
	\parsep=0pt plus 1pt % вертикальный отступ между абзацами внутри одного элемента
	\itemsep=\parsep % отступ между элементами одного перечня
}
\RequirePackage{enumitem}
%>> Внутри пунктов или подпунктов могут быть приведены перечисления. Перечисления выделяют абзацным отступом и перед каждой позицией перечисления ставят дефис.
\setlist[itemize]{label=-}
%>> При необходимости ссылки в тексте на одно или несколько перечислений перед каждой позицией вместо дефиса ставят строчную букву, приводимую в алфавитном порядке, а после нее – круглую скобку.
\newcommand*{\ralph}[1]{%
	\@ralph{\@nameuse{c@#1}}%
}
\newcommand*{\@ralph}[1]{%
	\ifcase #1\or а\or б\or в\or г\or д\or е\or ж\or з\or и\or
	к\or л\or м\or н\or о\or п\or р\or с\or т\or у\or
	ф\or х\or ц\or ч\or ш\or щ\or э\or ю\or я\else\@ctrerr \fi
}
\AddEnumerateCounter{\ralph}{\@ralph}{щ} 

\setlist[enumerate,1]{%
	label=\ralph*)%, ref=\theenumii.\roman*
}
%>> Для дальнейшей детализации перечисления используют арабские цифры со скобкой, приводя их со смещением вправо на два знака относительно перечислений, обозначенных буквами.
\setlist[enumerate,2]{%
	leftmargin=5mm, % два знака
	label=\arabic*)%, ref=\theenumii.\roman*
}
% Два гнусных хака. Разобраться с тем, как enumitem ломает наследовние параметров \@listI в \@listII
%\setlist[itemize,1]{itemsep=-1pt}
%\setlist[itemize,2]{itemsep=-1pt}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% Bibliography %%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% При использовании BibLaTeX'а
\RequirePackage[style=gost-numeric-min,backend=biber,sorting=none]{biblatex}
\AtEveryBibitem{\clearfield{day}} % Ещё один грязный хак. Не могу понять, почему соединяется год и дата
\AtEveryBibitem{\clearfield{note}}% Ещё один грязный хак. Не помню, какие мои действия с Zotero привели к экспорту этой странной информации в поле note 
% Переопределение команды, отвечающей за оформление заголовка записи. В противном случае, авторы (если <4) будут выводиться в \emph{}:
% \newcommand*{\mkgostheading}[1]{\mkbibemph{#1}}
\renewcommand*{\mkgostheading}[1]{#1}
\newcommand{\sourcelist}{
	% Вводит структурный элемент: новая страница, заголовок = {CAPS'ом, полужирным, центрирован}
	\struct{Список использованных источников}
	% Отключает стандартный заголовок
	\printbibliography[heading=none]
}
% При использовании стандарного thebibliography
\renewcommand{\@biblabel}[1]{#1.}
\addto\captionsrussian{\renewcommand{\refname}{Список использованных источников}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% Appendix %%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%>>7.11.2 Приложения обозначают прописными буквами русского алфавита, начиная с А (за исключением букв Ё, З, Й, О, Ч, Ь, Ы, Ъ), которые приводят после слова «ПРИЛОЖЕНИЕ» 
\newcommand*{\Ralph}[1]{\@Ralph{\@nameuse{c@#1}}}
\newcommand*{\@Ralph}[1]{%
	\ifcase #1\or А\or Б\or В\or Г\or Д\or Е\or Ж\or И\or
	К\or Л\or М\or Н\or П\or Р\or С\or Т\or У\or
	Ф\or Х\or Ц\or Ш\or Щ\or Э\or Ю\or Я\else\@ctrerr \fi
}
\AddEnumerateCounter{\Ralph}{\@Ralph}{Щ} 

\newcounter{appendix}% Нумерация приложений
\setcounter{appendix}{0}
\renewcommand\theappendix{\@Ralph\c@appendix}
%% Каждое приложение -- структурный элемент:
%>> Каждое приложение начинают с новой страницы.
%% Хотя
%>> 6.4.4 Допускается объединять все приложения под общим названием «Приложения», с указанием их обозначений и интервала номеров страниц. 
%% Это пока не реализовано
\renewcommand\appendix{
  \stepcounter{appendix}
  \struct{Приложение \theappendix}
%>> 7.11.5 Текст каждого приложения, при необходимости, может быть разделен на разделы, подразделы и пункты, которые нумеруют арабскими цифрами в пределах каждого приложения, добавляя перед номером обозначение приложения.
  \gdef\thesection{\theappendix.\@arabic\c@section}
}

%% Нужно реализовать:
%>> Если приложение представлено в виде таблицы и расположено на нескольких страницах, то на последующих страницах приложения пишут с начала строки «Продолжение приложения» или «Окончание приложения», указывают его обозначение, отделяют интервалом в одну строку и, повторяя головку таблицы, продолжают таблицу.

%% Рисунок в приложении
\newcounter{appfigure}[appendix]
\renewcommand\theappfigure {\theappendix.\@arabic\c@appfigure}
\def\fps@appfigure{htbp}
\def\ftype@appfigure{1}
\def\ext@appfigure{lof}
\def\fnum@appfigure{\figurename\nobreakspace\theappfigure}
\newenvironment{appfigure}
               {\@float{appfigure}}
               {\end@float}
%% Развёрнутый рисунок в приложении
% :(
%% Таблица в приложении
\newcounter{apptable}[appendix]
\renewcommand\theapptable{\theappendix.\@arabic\c@apptable}
\def\fps@apptable{htbp}
\def\ftype@apptable{2}
\def\ext@apptable{lot}
\def\fnum@apptable{\tablename\nobreakspace\theapptable}
\newenvironment{apptable}
               {\@float{apptable}}
               {\end@float}
